<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel ADM ‚Äî PNP</title>
  <meta name="theme-color" content="#0b0b0f" />
  <style>
    :root{
      --bg:#07070b; --panel:#0d0d14; --line:rgba(255,255,255,.10); --line2:rgba(255,255,255,.08);
      --text:#f3f3ff; --muted:#b8b8d6;
      --red:#ff2b2b; --ok:#25d366; --warn:#ffb020;
      --shadow:0 18px 60px rgba(0,0,0,.55); --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1100px 600px at 15% -10%, rgba(255,43,43,.16), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(255,43,43,.08), transparent 60%),
        radial-gradient(800px 500px at 30% 110%, rgba(255,255,255,.04), transparent 60%),
        var(--bg);
      color:var(--text);
      padding:18px;
    }
    .wrap{max-width:1200px;margin:0 auto}
    a{color:inherit}

    .topbar{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:14px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:46px;height:46px;border-radius:14px;display:grid;place-items:center;
      background:linear-gradient(135deg, rgba(255,43,43,.22), rgba(255,43,43,.06));
      border:1px solid rgba(255,43,43,.25); box-shadow:var(--shadow);
      font-size:22px;
    }
    .brand h1{font-size:18px;margin:0;letter-spacing:.2px}
    .brand .sub{margin-top:3px;color:var(--muted);font-size:12px}

    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:10px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line2);
      padding:10px 12px;border-radius:999px;color:var(--muted);font-size:13px;
    }
    .chip b{color:var(--text)}
    .btn{
      border:none;border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer;
      background:rgba(255,43,43,.18); border:1px solid rgba(255,43,43,.30); color:var(--text);
      transition:transform .08s ease, filter .15s ease, background .15s ease;
    }
    .btn:hover{filter:brightness(1.08); background:rgba(255,43,43,.24)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:rgba(255,255,255,.04); border:1px solid var(--line2)}
    .btn.ok{background:rgba(37,211,102,.14); border:1px solid rgba(37,211,102,.26)}
    .btn.danger{background:rgba(255,43,43,.22); border:1px solid rgba(255,43,43,.32)}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width: 980px){ .grid{grid-template-columns: 1fr 1fr 1fr 1fr} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
    }
    .card.pad{padding:14px}
    .statTitle{color:var(--muted);font-size:12px;margin:0 0 6px 0}
    .statValue{font-size:22px;font-weight:1000;margin:0}
    .statHint{color:var(--muted);font-size:12px;margin-top:8px}
    .dot{display:inline-block;width:9px;height:9px;border-radius:99px;margin-right:8px;vertical-align:middle}
    .dot.red{background:var(--red)}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}

    .panel{margin-top:12px;display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width: 980px){ .panel{grid-template-columns: 1.2fr .8fr} }

    .panelHeader{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:10px;padding:14px 14px 10px 14px;border-bottom:1px solid var(--line2)}
    .panelHeader h2{margin:0;font-size:14px;letter-spacing:.2px}
    .panelHeader p{margin:4px 0 0;color:var(--muted);font-size:12px}
    .filters{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .input,.select{
      background:rgba(0,0,0,.22); border:1px solid var(--line2); color:var(--text);
      padding:10px 12px;border-radius:14px; outline:none;
    }
    .input{min-width:220px}

    .tableWrap{padding:10px 14px 14px 14px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th{text-align:left;font-size:12px;color:var(--muted);font-weight:800;padding:0 10px 6px 10px}
    td{padding:12px 10px;background:rgba(0,0,0,.20);border-top:1px solid var(--line2);border-bottom:1px solid var(--line2)}
    tr td:first-child{border-left:1px solid var(--line2);border-top-left-radius:14px;border-bottom-left-radius:14px}
    tr td:last-child{border-right:1px solid var(--line2);border-top-right-radius:14px;border-bottom-right-radius:14px}

    .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line2);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px;white-space:nowrap}
    .tag.pending{border-color:rgba(255,176,32,.30); color:#ffd9a0}
    .tag.approved{border-color:rgba(37,211,102,.28); color:#b9f0cf}
    .tag.rejected{border-color:rgba(255,43,43,.30); color:#ffb1b1}

    .rowBtns{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
    .mini{padding:9px 10px;border-radius:12px;font-weight:900;border:1px solid var(--line2);background:rgba(255,255,255,.04);cursor:pointer}
    .mini.ok{border-color:rgba(37,211,102,.26);background:rgba(37,211,102,.12)}
    .mini.danger{border-color:rgba(255,43,43,.30);background:rgba(255,43,43,.14)}
    .mini:hover{filter:brightness(1.06)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}

    .sideBody{padding:12px 14px 14px 14px}
    .box{background:rgba(0,0,0,.20);border:1px solid var(--line2);border-radius:16px;padding:12px;margin-top:10px}
    .box h3{margin:0 0 6px 0;font-size:13px}
    .box p{margin:0;color:var(--muted);font-size:12px;line-height:1.45}
    .kvs{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .kv{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .kv span{color:var(--muted);font-size:12px}
    .kv b{font-size:12px}
    .footer{margin-top:12px;color:var(--muted);font-size:12px;opacity:.9}

    .toastWrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:10px;z-index:9999}
    .toastItem{
      min-width:260px;max-width:380px;
      background:rgba(10,10,16,.92);
      border:1px solid var(--line2);box-shadow:var(--shadow);
      border-radius:16px;padding:12px;
      backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
      animation: pop .14s ease-out;
    }
    @keyframes pop{from{transform:translateY(6px);opacity:0}to{transform:none;opacity:1}}
    .toastItem small{display:block;color:var(--muted);margin-top:4px}

    .modalBg{position:fixed;inset:0;background:rgba(0,0,0,.62);display:none;align-items:center;justify-content:center;z-index:9998;padding:18px}
    .modal{width:min(760px,100%);background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));border:1px solid var(--line);border-radius:20px;box-shadow:var(--shadow);overflow:hidden}
    .modalHeader{padding:14px;border-bottom:1px solid var(--line2);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modalHeader h3{margin:0;font-size:14px}
    .modalBody{padding:14px}
    .modalBody pre{margin:0;white-space:pre-wrap;background:rgba(0,0,0,.25);border:1px solid var(--line2);border-radius:14px;padding:12px;color:#d9d9ff}
    .closeX{background:transparent;border:1px solid var(--line2);color:var(--text);border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:900}

    .empty{padding:14px;color:var(--muted);font-size:13px;border:1px dashed rgba(255,255,255,.14);border-radius:16px;background:rgba(255,255,255,.03)}
    .loginBg{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:99999;padding:18px}
    .login{
      width:min(520px,100%);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line); border-radius:22px; box-shadow:var(--shadow); overflow:hidden;
    }
    .loginHeader{padding:16px;border-bottom:1px solid var(--line2)}
    .loginHeader h2{margin:0;font-size:16px}
    .loginHeader p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.45}
    .loginBody{padding:16px;display:grid;gap:10px}
    .loginBody input{
      width:100%;
      background:rgba(0,0,0,.22); border:1px solid var(--line2); color:var(--text);
      padding:12px 12px;border-radius:14px; outline:none;
    }
    .loginRow{display:flex;gap:10px;flex-wrap:wrap}
    .loginRow button{flex:1}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo">ü¶∂</div>
        <div>
          <h1>Painel ADM ‚Äî PNP</h1>
          <div class="sub">Aprova√ß√£o manual ‚Ä¢ login por ADMIN_API_KEY ‚Ä¢ rotas /api auto</div>
        </div>
      </div>

      <div class="actions">
        <div class="chip">Status: <b id="statusTxt">deslogado</b></div>
        <button class="btn secondary" id="btnTest">Testar API</button>
        <button class="btn" id="btnRefresh">Atualizar</button>
      </div>
    </div>

    <div class="grid">
      <div class="card pad">
        <p class="statTitle"><span class="dot warn"></span>Pendentes</p>
        <p class="statValue" id="statPending">‚Äî</p>
        <div class="statHint">Aguardando decis√£o do staff</div>
      </div>
      <div class="card pad">
        <p class="statTitle"><span class="dot ok"></span>Aprovados (24h)</p>
        <p class="statValue" id="statApproved">‚Äî</p>
        <div class="statHint">Aprova√ß√µes recentes</div>
      </div>
      <div class="card pad">
        <p class="statTitle"><span class="dot red"></span>Recusados (24h)</p>
        <p class="statValue" id="statRejected">‚Äî</p>
        <div class="statHint">Recusas recentes</div>
      </div>
      <div class="card pad">
        <p class="statTitle"><span class="dot red"></span>API</p>
        <p class="statValue mono" id="statApi">‚Äî</p>
        <div class="statHint">Base detectada</div>
      </div>
    </div>

    <div class="panel">
      <div class="card">
        <div class="panelHeader">
          <div>
            <h2>üì• Formul√°rios</h2>
            <p>Veja, filtre e aprove/recuse.</p>
          </div>

          <div class="filters">
            <input class="input" id="q" placeholder="Pesquisar (nick, discord...)" />
            <select class="select" id="status">
              <option value="all">Todos</option>
              <option value="pending" selected>Pendentes</option>
              <option value="approved">Aprovados</option>
              <option value="rejected">Recusados</option>
            </select>
          </div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Usu√°rio</th>
                <th>Nick</th>
                <th>Idade</th>
                <th>Status</th>
                <th>Quando</th>
                <th style="text-align:right">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <div id="empty" class="empty" style="display:none">Nada aqui ainda.</div>
        </div>
      </div>

      <div class="card">
        <div class="panelHeader">
          <div>
            <h2>‚öôÔ∏è Configura√ß√£o</h2>
            <p>API + chave do painel.</p>
          </div>
        </div>
        <div class="sideBody">

          <div class="box">
            <h3>üîå Conex√£o</h3>
            <p>Este painel fala com sua API (ShardCloud). Login √© s√≥ pela ADMIN_API_KEY.</p>

            <div class="kvs">
              <div class="kv"><span>API Base</span><b class="mono" id="kvApi">‚Äî</b></div>
              <div class="kv"><span>Key</span><b class="mono" id="kvKey">‚Äî</b></div>
              <div class="kv"><span>Prefix</span><b class="mono" id="kvPrefix">‚Äî</b></div>
            </div>

            <div class="loginRow" style="margin-top:12px">
              <button class="btn secondary" id="btnLogout">Trocar login</button>
              <button class="btn ok" id="btnLoadAll">Ver todos</button>
            </div>
          </div>

          <div class="box">
            <h3>üß† Dicas</h3>
            <p>
              ‚Ä¢ Se ‚ÄúTestar API‚Äù der erro, o <b>API_BASE</b> est√° errado.<br/>
              ‚Ä¢ Se der 401, a <b>ADMIN_API_KEY</b> est√° errada.<br/>
              ‚Ä¢ A dashboard tenta <b>/health</b> e <b>/api/health</b> automaticamente.
            </p>
          </div>

          <div class="footer">PNP ‚Ä¢ dashboard √∫nica ‚Ä¢ sem frescura</div>
        </div>
      </div>
    </div>

  </div>

  <div class="toastWrap" id="toast"></div>

  <div class="modalBg" id="modalBg" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <h3 id="modalTitle">Detalhes</h3>
        <button class="closeX" id="modalClose">Fechar</button>
      </div>
      <div class="modalBody">
        <pre id="modalPre"></pre>
      </div>
    </div>
  </div>

  <div class="loginBg" id="loginBg">
    <div class="login">
      <div class="loginHeader">
        <h2>Login do Staff</h2>
        <p>Coloque a URL da sua API e a ADMIN_API_KEY. Sem isso o painel n√£o abre.</p>
      </div>
      <div class="loginBody">
        <input id="inApi" placeholder="API_BASE (ex: https://pnp-api.shardweb.app)" />
        <input id="inKey" placeholder="ADMIN_API_KEY" />
        <div class="loginRow">
          <button class="btn ok" id="btnLogin">Entrar</button>
          <button class="btn secondary" id="btnPrefill">Preencher exemplo</button>
        </div>
        <div class="chip">Dica: pode colar com <b>/api</b> no final que eu arrumo.</div>
      </div>
    </div>
  </div>

<script>
  // ========= Utils UI =========
  const $ = (id) => document.getElementById(id);

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }

  function toast(msg, kind="info"){
    const el = document.createElement("div");
    el.className = "toastItem";
    el.innerHTML = `<b>${kind === "ok" ? "‚úÖ" : kind === "err" ? "‚ùå" : "‚ÑπÔ∏è"} ${escapeHtml(msg)}</b><small>${new Date().toLocaleString()}</small>`;
    $("toast").appendChild(el);
    setTimeout(()=> el.remove(), 3800);
  }

  function setStatus(txt, ok=null){
    $("statusTxt").textContent = txt;
    $("statusTxt").style.color = ok === true ? "#b9f0cf" : ok === false ? "#ffb1b1" : "";
  }

  function openModal(title, obj){
    $("modalTitle").textContent = title;
    $("modalPre").textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    $("modalBg").style.display = "flex";
  }
  function closeModal(){ $("modalBg").style.display = "none"; }
  $("modalClose").addEventListener("click", closeModal);
  $("modalBg").addEventListener("click", (e)=>{ if(e.target === $("modalBg")) closeModal(); });

  // ========= Config storage =========
  function normalizeBase(u){
    u = String(u||"").trim().replace(/\/+$/,"");
    // remove /api no final se o cara colar
    if (u.endsWith("/api")) u = u.slice(0, -4);
    return u;
  }

  function setCfg(API_BASE, ADMIN_API_KEY){
    localStorage.setItem("PNP_API_BASE", normalizeBase(API_BASE));
    localStorage.setItem("PNP_ADMIN_KEY", String(ADMIN_API_KEY||"").trim());
  }
  function getCfg(){
    const API_BASE = normalizeBase(localStorage.getItem("PNP_API_BASE") || "");
    const ADMIN_API_KEY = String(localStorage.getItem("PNP_ADMIN_KEY") || "").trim();
    return { API_BASE, ADMIN_API_KEY };
  }
  function clearCfg(){
    localStorage.removeItem("PNP_API_BASE");
    localStorage.removeItem("PNP_ADMIN_KEY");
  }

  // ========= API detection (com e sem /api) =========
  let __prefix = null; // "" ou "/api"

  async function detectPrefix(){
    if (__prefix !== null) return __prefix;
    const { API_BASE } = getCfg();
    if (!API_BASE) throw new Error("API_BASE vazio.");

    const tries = [
      { prefix:"", path:"/health" },
      { prefix:"/api", path:"/health" }
    ];

    for (const t of tries){
      try{
        const r = await fetch(API_BASE + t.prefix + t.path, { method:"GET" });
        if (r.ok) { __prefix = t.prefix; return __prefix; }
      }catch(_){}
    }
    // fallback
    __prefix = "";
    return __prefix;
  }

  async function api(path, opts={}){
    const { API_BASE, ADMIN_API_KEY } = getCfg();
    if (!API_BASE) throw new Error("API_BASE vazio.");

    const prefix = await detectPrefix();
    const url = API_BASE + prefix + path;

    const headers = Object.assign({
      "Content-Type":"application/json",
    }, opts.headers || {});

    if (ADMIN_API_KEY) headers["Authorization"] = "Bearer " + ADMIN_API_KEY;

    const res = await fetch(url, Object.assign({}, opts, { headers }));

    let data = null;
    try { data = await res.json(); } catch(e){}

    if(!res.ok){
      const msg = (data && (data.error || data.message)) ? (data.error || data.message) : ("HTTP " + res.status);
      throw new Error(msg);
    }
    return data;
  }

  async function hardTest(){
    __prefix = null; // for√ßa redetectar
    const prefix = await detectPrefix();
    const { API_BASE } = getCfg();
    const data = await api("/health", { method:"GET", headers: {} });
    $("statApi").textContent = API_BASE + prefix;
    $("kvPrefix").textContent = prefix || "(sem /api)";
    toast("API OK: " + (data.status || data.ok || "ok"), "ok");
    return true;
  }

  // ========= Data/UI =========
  function fmtTime(ts){
    if(!ts) return "‚Äî";
    const d = new Date(ts);
    const diff = Date.now() - d.getTime();
    const mins = Math.floor(diff/60000);
    if(mins < 1) return "agora";
    if(mins < 60) return mins + " min";
    const hrs = Math.floor(mins/60);
    if(hrs < 24) return hrs + " h";
    const days = Math.floor(hrs/24);
    return days + " d";
  }

  function tagHtml(status){
    if(status === "approved") return `<span class="tag approved">‚úÖ aprovado</span>`;
    if(status === "rejected") return `<span class="tag rejected">‚ùå recusado</span>`;
    return `<span class="tag pending">‚è≥ pendente</span>`;
  }

  let cache = [];
  let forceAll = false;

  function applyFilter(){
    const q = $("q").value.trim().toLowerCase();
    const st = $("status").value;

    const rows = cache.filter(x=>{
      const okStatus = (st === "all") ? true : (x.status === st);
      if(!okStatus) return false;
      if(!q) return true;

      const hay = [
        x.discordTag, x.userId, x.nick, x.token, x.linkBonde
      ].filter(Boolean).join(" ").toLowerCase();

      return hay.includes(q);
    });

    render(rows);
  }

  function render(rows){
    const tb = $("tbody");
    tb.innerHTML = "";
    $("empty").style.display = rows.length ? "none" : "block";

    for(const item of rows){
      const tr = document.createElement("tr");

      const user = escapeHtml(item.discordTag || ("ID:" + (item.userId||"‚Äî")));
      const nick = escapeHtml(item.nick || "‚Äî");
      const idade = item.idade != null ? escapeHtml(item.idade) : "‚Äî";
      const when = fmtTime(item.createdAt || item.updatedAt);

      const actions = `
        <div class="rowBtns">
          <button class="mini" data-act="view" data-id="${escapeHtml(item.id)}">Detalhes</button>
          ${item.status === "pending" ? `
            <button class="mini ok" data-act="approve" data-id="${escapeHtml(item.id)}">Aprovar</button>
            <button class="mini danger" data-act="reject" data-id="${escapeHtml(item.id)}">Recusar</button>
          ` : `
            <button class="mini secondary" data-act="setPending" data-id="${escapeHtml(item.id)}">Voltar p/ pendente</button>
          `}
        </div>
      `;

      tr.innerHTML = `
        <td><b>${user}</b><div class="mono" style="color:var(--muted);font-size:11px;margin-top:4px">${escapeHtml(item.userId || "")}</div></td>
        <td>${nick}</td>
        <td>${idade}</td>
        <td>${tagHtml(item.status || "pending")}</td>
        <td>${escapeHtml(when)}</td>
        <td style="text-align:right">${actions}</td>
      `;
      tb.appendChild(tr);
    }
  }

  async function load(){
    try{
      setStatus("carregando...", null);

      const st = forceAll ? "all" : $("status").value;
      // sua API pode ignorar status ‚Äî tudo bem, a gente filtra do lado do cliente tamb√©m
      const data = await api(`/admin/submissions?status=${encodeURIComponent(st)}`);

      cache = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
      setStatus("online", true);

      $("statPending").textContent  = data.stats?.pending ?? cache.filter(x=>x.status==="pending").length;
      $("statApproved").textContent = data.stats?.approved24h ?? "‚Äî";
      $("statRejected").textContent = data.stats?.rejected24h ?? "‚Äî";

      applyFilter();
    }catch(e){
      setStatus("offline", false);
      toast(String(e.message || e), "err");
      cache = [];
      render([]);
      $("statPending").textContent = "‚Äî";
      $("statApproved").textContent = "‚Äî";
      $("statRejected").textContent = "‚Äî";
    }finally{
      forceAll = false;
    }
  }

  async function approve(id){
    const reason = prompt("Motivo da aprova√ß√£o (opcional):") || "";
    try{
      toast("Aprovando...", "info");
      await api(`/admin/submissions/${encodeURIComponent(id)}/approve`, {
        method:"POST",
        body: JSON.stringify({ reason })
      });
      toast("Aprovado!", "ok");
      await load();
    }catch(e){
      toast(e.message || e, "err");
    }
  }

  async function reject(id){
    const reason = prompt("Motivo da recusa (recomendado):") || "";
    if(!reason.trim()){
      toast("Recusa cancelada (sem motivo).", "info");
      return;
    }
    try{
      toast("Recusando...", "info");
      await api(`/admin/submissions/${encodeURIComponent(id)}/reject`, {
        method:"POST",
        body: JSON.stringify({ reason })
      });
      toast("Recusado!", "ok");
      await load();
    }catch(e){
      toast(e.message || e, "err");
    }
  }

  async function setPending(id){
    try{
      toast("Voltando p/ pendente...", "info");
      await api(`/admin/submissions/${encodeURIComponent(id)}/pending`, { method:"POST" });
      toast("Ok!", "ok");
      await load();
    }catch(e){
      toast(e.message || e, "err");
    }
  }

  function findById(id){
    return cache.find(x => String(x.id) === String(id)) || null;
  }

  // ========= Events =========
  $("btnRefresh").addEventListener("click", load);
  $("btnLoadAll").addEventListener("click", ()=>{ forceAll = true; load(); });

  $("btnTest").addEventListener("click", async ()=>{
    try{
      await hardTest();
    }catch(e){
      toast("Falha: " + (e.message || e), "err");
    }
  });

  $("q").addEventListener("input", applyFilter);
  $("status").addEventListener("change", load);

  $("tbody").addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.getAttribute("data-act");
    const id = btn.getAttribute("data-id");
    if(!act || !id) return;

    if(act === "view"){
      const item = findById(id);
      if(!item){ toast("Item n√£o encontrado.", "err"); return; }
      openModal("Detalhes do formul√°rio", item);
      return;
    }
    if(act === "approve") return approve(id);
    if(act === "reject") return reject(id);
    if(act === "setPending") return setPending(id);
  });

  // ========= Login flow =========
  function showLogin(show){
    $("loginBg").style.display = show ? "flex" : "none";
  }

  $("btnLogin").addEventListener("click", async ()=>{
    const apiBase = $("inApi").value;
    const key = $("inKey").value;
    setCfg(apiBase, key);
    __prefix = null;

    // atualiza labels
    const cfg = getCfg();
    $("kvApi").textContent = cfg.API_BASE || "‚Äî";
    $("kvKey").textContent = cfg.ADMIN_API_KEY ? (cfg.ADMIN_API_KEY.slice(0,4) + "..." + cfg.ADMIN_API_KEY.slice(-4)) : "‚Äî";

    try{
      setStatus("testando...", null);
      await hardTest();
      showLogin(false);
      setStatus("online", true);
      toast("Login OK", "ok");
      await load();
    }catch(e){
      setStatus("falhou", false);
      toast("Erro: " + (e.message || e), "err");
      // mant√©m login aberto
      showLogin(true);
    }
  });

  $("btnPrefill").addEventListener("click", ()=>{
    $("inApi").value = "https://pnp-api.shardweb.app";
    $("inKey").value = "";
  });

  $("btnLogout").addEventListener("click", ()=>{
    clearCfg();
    __prefix = null;
    setStatus("deslogado", null);
    $("statApi").textContent = "‚Äî";
    $("kvApi").textContent = "‚Äî";
    $("kvKey").textContent = "‚Äî";
    $("kvPrefix").textContent = "‚Äî";
    cache = [];
    render([]);
    showLogin(true);
  });

  // ========= Boot =========
  (function boot(){
    const cfg = getCfg();
    $("kvApi").textContent = cfg.API_BASE || "‚Äî";
    $("kvKey").textContent = cfg.ADMIN_API_KEY ? (cfg.ADMIN_API_KEY.slice(0,4) + "..." + cfg.ADMIN_API_KEY.slice(-4)) : "‚Äî";
    $("statApi").textContent = "‚Äî";
    $("kvPrefix").textContent = "‚Äî";

    if(!cfg.API_BASE || !cfg.ADMIN_API_KEY){
      setStatus("deslogado", null);
      showLogin(true);
      return;
    }
    showLogin(false);
    (async ()=>{
      try{
        setStatus("testando...", null);
        await hardTest();
        setStatus("online", true);
        await load();
      }catch(e){
        toast("Login falhou: " + (e.message || e), "err");
        setStatus("deslogado", false);
        showLogin(true);
      }
    })();
  })();
</script>
</body>
</html>
