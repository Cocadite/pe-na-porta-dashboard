<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PNP Dashboard</title>
  <style>
    :root{
      --bg:#07070b;--card:#10101a;--card2:#0c0c13;--line:rgba(255,255,255,.10);
      --text:#f3f3ff;--muted:#b8b8d6;--red:#ff1a1a;--green:#5CFF9A;--shadow:0 18px 60px rgba(0,0,0,.55);--radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1100px 600px at 15% -10%, rgba(255,26,26,.16), transparent 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(255,26,26,.10), transparent 60%),
        var(--bg);
      color:var(--text);padding:22px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px}
    .title{display:flex;align-items:center;gap:12px}
    .logo{width:46px;height:46px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(135deg, rgba(255,26,26,.26), rgba(255,26,26,.08));border:1px solid rgba(255,26,26,.28);box-shadow:var(--shadow);font-size:22px}
    h1{margin:0;font-size:20px}
    .sub{margin:4px 0 0;color:var(--muted);font-size:13px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,select,button{border-radius:14px;border:1px solid rgba(255,255,255,.12);background:var(--card2);color:var(--text);padding:12px 12px;font-size:14px;outline:none}
    button{cursor:pointer;font-weight:900}
    .btnRed{background:var(--red);color:#111;border:none}
    .btnGreen{background:var(--green);color:#111;border:none}
    .btnGhost{background:transparent}
    .pill{display:inline-flex;align-items:center;gap:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:999px;color:var(--muted);font-size:13px}
    .pill b{color:var(--text)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;padding:14px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .item{padding:14px;border-top:1px solid rgba(255,255,255,.08)}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:6px}
    .name{display:flex;align-items:center;gap:10px}
    .tag{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
    .motivo{margin-top:10px;color:#e9e9ff;white-space:pre-wrap}
    .actions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    .hidden{display:none}
    .alert{padding:12px 14px;border-top:1px solid rgba(255,255,255,.08);color:var(--muted)}
    a{color:#fff}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="title">
      <div class="logo">ü¶∂</div>
      <div>
        <h1>PNP Dashboard</h1>
        <div class="sub">Login por chave ‚Ä¢ Aprova no painel ‚Ä¢ Bot d√° o cargo via webhook</div>
      </div>
    </div>

    <div class="row">
      <span class="pill">API: <b id="apiShow">‚Äî</b></span>
      <button class="btnGhost" onclick="logout()">Sair</button>
    </div>
  </div>

  <div class="card" id="loginCard">
    <div style="padding:14px">
      <div class="row">
        <input id="apiBase" placeholder="API Base (ex: https://pnp-api.shardweb.app)" style="min-width:320px" />
        <input id="key" placeholder="ADMIN_API_KEY" style="min-width:320px" />
        <button class="btnRed" onclick="saveLogin()">Entrar</button>
      </div>
      <div class="alert">Dica: A chave fica salva s√≥ no seu navegador (localStorage).</div>
    </div>
  </div>

  <div class="card hidden" id="dashCard">
    <div style="padding:14px" class="row">
      <select id="filter" onchange="render()">
        <option value="pending">Pendentes</option>
        <option value="approved">Aprovados</option>
        <option value="rejected">Recusados</option>
        <option value="all">Tudo</option>
      </select>
      <button onclick="load()" class="btnGhost">Atualizar</button>
      <span class="pill">Total: <b id="total">0</b></span>
    </div>
    <div id="list"></div>
    <div class="alert" id="status">‚Äî</div>
  </div>
</div>

<script>
  let submissions = [];

  function getApi(){ return (localStorage.getItem("PNP_API_BASE") || "").replace(/\/+$/,""); }
  function getKey(){ return (localStorage.getItem("PNP_ADMIN_KEY") || "").trim(); }

  function saveLogin(){
    const api = document.getElementById("apiBase").value.trim().replace(/\/+$/,"");
    const key = document.getElementById("key").value.trim();
    if(!api) return alert("Coloca a API Base");
    if(!key) return alert("Coloca a ADMIN_API_KEY");
    localStorage.setItem("PNP_API_BASE", api);
    localStorage.setItem("PNP_ADMIN_KEY", key);
    boot();
  }

  function logout(){
    localStorage.removeItem("PNP_API_BASE");
    localStorage.removeItem("PNP_ADMIN_KEY");
    location.reload();
  }

  async function api(path, opts={}){
    const base = getApi();
    const key = getKey();
    const r = await fetch(base + path, {
      ...opts,
      headers: {
        "Content-Type":"application/json",
        "Authorization":"Bearer " + key,
        ...(opts.headers || {})
      }
    });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(data.error || ("HTTP "+r.status));
    return data;
  }

  async function load(){
    try{
      setStatus("Carregando...");
      submissions = await api("/admin/submissions");
      document.getElementById("total").textContent = submissions.length;
      render();
      setStatus("‚úÖ Atualizado");
    }catch(e){
      setStatus("‚ùå " + (e.message || e));
    }
  }

  function render(){
    const f = document.getElementById("filter").value;
    const list = document.getElementById("list");
    list.innerHTML = "";

    const items = submissions.filter(s => {
      if(f==="all") return true;
      return (s.status || "pending") === f;
    });

    items.forEach(s => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="name">
          <b>${escapeHtml(s.nick || "-")}</b>
          <span class="tag">${escapeHtml(s.status || "pending")}</span>
          <span class="tag">${escapeHtml(s.discordTag || s.userId || "-")}</span>
        </div>
        <div class="meta">
          <span>Idade: <b>${escapeHtml(String(s.idade||"-"))}</b></span>
          <span>Link: <a href="${escapeAttr(s.linkBonde||"#")}" target="_blank">${escapeHtml(s.linkBonde||"-")}</a></span>
          <span>ID: <b>${escapeHtml(s.id||"-")}</b></span>
        </div>
        <div class="motivo">${escapeHtml(s.motivo || "-")}</div>
        <div class="actions">
          <button class="btnGreen" ${s.status==="approved"?"disabled":""} onclick="approve('${s.id}')">Aprovar</button>
          <button class="btnRed" ${s.status==="rejected"?"disabled":""} onclick="reject('${s.id}')">Recusar</button>
        </div>
      `;
      list.appendChild(div);
    });
  }

  async function approve(id){
    if(!confirm("Aprovar e dar cargo?")) return;
    try{
      setStatus("Aprovando...");
      await api(`/admin/submissions/${id}/approve`, { method:"POST" });
      await load();
    }catch(e){ setStatus("‚ùå " + (e.message || e)); }
  }

  async function reject(id){
    if(!confirm("Recusar?")) return;
    try{
      setStatus("Recusando...");
      await api(`/admin/submissions/${id}/reject`, { method:"POST" });
      await load();
    }catch(e){ setStatus("‚ùå " + (e.message || e)); }
  }

  function setStatus(t){ document.getElementById("status").textContent = t; }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }
  function escapeAttr(s){
    return String(s).replace(/"/g,'&quot;');
  }

  function boot(){
    const api = getApi();
    const key = getKey();
    document.getElementById("apiShow").textContent = api || "‚Äî";

    document.getElementById("apiBase").value = api || "https://pnp-api.shardweb.app";
    document.getElementById("key").value = key || "";

    const logged = !!api && !!key;
    document.getElementById("loginCard").classList.toggle("hidden", logged);
    document.getElementById("dashCard").classList.toggle("hidden", !logged);

    if(logged) load();
  }

  boot();
</script>
</body>
</html>
