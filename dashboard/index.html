<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‚Äî P√© Na Porta</title>
  <meta name="theme-color" content="#0b0b0f" />
  <style>
    :root{
      --bg:#07070b;--card:#0f0f18;--card2:#0b0b12;--line:#25253a;--text:#f3f3ff;--muted:#b8b8d6;
      --red:#ff1a1a;--green:#7cfc90;--yellow:#ffd24a;
      --shadow:0 18px 60px rgba(0,0,0,.55);--radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:
      radial-gradient(1200px 700px at 20% -10%, rgba(255,26,26,.18), transparent 55%),
      radial-gradient(900px 600px at 95% 0%, rgba(124,252,144,.10), transparent 60%),
      var(--bg);color:var(--text)}
    .wrap{max-width:1150px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:46px;height:46px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(135deg, rgba(255,26,26,.26), rgba(255,26,26,.08));border:1px solid rgba(255,26,26,.28);box-shadow:var(--shadow);font-size:22px}
    h1{font-size:20px;margin:0;letter-spacing:.3px}
    .sub{margin:4px 0 0;color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .chip{display:inline-flex;align-items:center;gap:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:999px;color:var(--muted);font-size:13px}
    .chip input{border:none;outline:none;background:transparent;color:var(--text);min-width:220px;font-size:13px}
    .btn{border:none;border-radius:14px;padding:12px 14px;font-weight:900;cursor:pointer;background:var(--red);color:#101010;letter-spacing:.2px;transition:transform .08s ease, filter .15s ease}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn2{background:transparent;border:1px solid rgba(255,255,255,.14);color:var(--text);font-weight:800}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .cardHead{padding:14px 14px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .cardHead b{letter-spacing:.2px}
    .cardBody{padding:14px}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width: 600px){ .kpis{grid-template-columns:1fr} }
    .kpi{background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px;position:relative;overflow:hidden}
    .kpi:before{content:"";position:absolute;inset:-40px -40px auto auto;width:120px;height:120px;border-radius:999px;background:radial-gradient(circle at 30% 30%, rgba(255,26,26,.25), transparent 60%);filter:blur(0px)}
    .kpi .n{font-size:24px;font-weight:1000}
    .kpi .t{color:var(--muted);font-size:12px;margin-top:2px}
    .list{display:grid;gap:10px}
    .item{background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px;display:grid;gap:8px;position:relative;overflow:hidden;transform:translateY(0);animation:pop .25s ease}
    @keyframes pop{from{transform:translateY(6px);opacity:.0}to{transform:translateY(0);opacity:1}}
    .itemTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .title{font-weight:1000}
    .meta{color:var(--muted);font-size:12px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    .badge.pending{border-color:rgba(255,210,74,.35)}
    .badge.approved{border-color:rgba(124,252,144,.35)}
    .badge.rejected{border-color:rgba(255,77,77,.35)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .a{border:none;border-radius:12px;padding:10px 12px;font-weight:1000;cursor:pointer}
    .a.ok{background:rgba(124,252,144,.90);color:#08110a}
    .a.no{background:rgba(255,77,77,.92);color:#180606}
    .a.ghost{background:transparent;border:1px solid rgba(255,255,255,.14);color:var(--text)}
    .log{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:var(--muted);line-height:1.5;white-space:pre-wrap}
    .hint{color:var(--muted);font-size:12px}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:rgba(15,15,24,.92);border:1px solid rgba(255,255,255,.10);color:var(--text);padding:10px 12px;border-radius:14px;box-shadow:var(--shadow);display:none;max-width:min(740px, calc(100% - 22px))}
    .toast.show{display:block;animation:pop .2s ease}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">üõ°Ô∏è</div>
        <div>
          <h1>Dashboard de Aprova√ß√£o</h1>
          <div class="sub">Aprovar/Rejeitar inscri√ß√µes ‚Ä¢ Atualiza a cada 5s</div>
        </div>
      </div>

      <div class="row">
        <div class="chip">
          API
          <input id="api" placeholder="https://api-pe-na-porta.vercel.app" />
        </div>
        <div class="chip">
          KEY
          <input id="key" placeholder="Bearer key (s√≥ aqui no dashboard)" />
        </div>
        <button class="btn2 btn" style="background:transparent;border:1px solid rgba(255,255,255,.14);color:var(--text)" onclick="saveCfg()">Salvar</button>
        <button class="btn" onclick="refreshNow()">Atualizar</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHead">
          <b>Fila</b>
          <span class="hint" id="status">‚Äî</span>
        </div>
        <div class="cardBody">
          <div class="kpis">
            <div class="kpi"><div class="n" id="kPending">0</div><div class="t">Pendentes</div></div>
            <div class="kpi"><div class="n" id="kApproved">0</div><div class="t">Aprovados</div></div>
            <div class="kpi"><div class="n" id="kRejected">0</div><div class="t">Rejeitados</div></div>
          </div>

          <div style="height:12px"></div>

          <div class="list" id="list"></div>
          <div class="small" style="margin-top:10px">
            Dica: o bot pega os aprovados na rota <code>/api/bot/approved</code> e marca como done em <code>/api/bot/mark-done</code>.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <b>Logs (local)</b>
          <span class="hint">√∫ltimas a√ß√µes</span>
        </div>
        <div class="cardBody">
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  const LS_KEY = "PENAPORTA_DASH_CFG_V1";
  const DEFAULT_API = "https://api-pe-na-porta.vercel.app";

  const elApi = document.getElementById("api");
  const elKey = document.getElementById("key");
  const elStatus = document.getElementById("status");
  const elList = document.getElementById("list");
  const elLog = document.getElementById("log");

  const toast = (t) => {
    const el = document.getElementById("toast");
    el.textContent = t;
    el.classList.add("show");
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> el.classList.remove("show"), 1800);
  };

  function readCfg(){
    try{
      const c = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
      elApi.value = c.api || DEFAULT_API;
      elKey.value = c.key || "";
    }catch{
      elApi.value = DEFAULT_API;
      elKey.value = "";
    }
  }
  function saveCfg(){
    const api = (elApi.value || DEFAULT_API).trim().replace(/\/$/, "");
    const key = (elKey.value || "").trim();
    localStorage.setItem(LS_KEY, JSON.stringify({ api, key }));
    toast("Config salvo ‚úÖ");
  }

  function authHeaders(){
    const key = (elKey.value || "").trim();
    return key ? { "Authorization": key.startsWith("Bearer ") ? key : ("Bearer " + key) } : {};
  }

  function badgeClass(s){
    if(s==="approved") return "approved";
    if(s==="rejected") return "rejected";
    return "pending";
  }
  function fmtTime(ms){
    try{
      const d = new Date(ms);
      return d.toLocaleString();
    }catch{return "‚Äî"}
  }
  function logLine(line){
    const prev = elLog.textContent.trim();
    elLog.textContent = (line + "\n" + prev).slice(0, 4000);
  }

  async function apiGet(path){
    const api = (elApi.value || DEFAULT_API).trim().replace(/\/$/, "");
    const res = await fetch(api + path, { headers: { ...authHeaders() }});
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(data.error || ("HTTP "+res.status));
    return data;
  }

  async function apiPost(path){
    const api = (elApi.value || DEFAULT_API).trim().replace(/\/$/, "");
    const res = await fetch(api + path, {
      method:"POST",
      headers: { "Content-Type":"application/json", ...authHeaders() },
      body: JSON.stringify({})
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(data.error || ("HTTP "+res.status));
    return data;
  }

  function render(items){
    const pending = items.filter(x=>x.status==="pending").length;
    const approved = items.filter(x=>x.status==="approved").length;
    const rejected = items.filter(x=>x.status==="rejected").length;
    document.getElementById("kPending").textContent = pending;
    document.getElementById("kApproved").textContent = approved;
    document.getElementById("kRejected").textContent = rejected;

    // Mostra pending primeiro
    const sorted = [...items].sort((a,b)=>{
      const w = (s)=> s==="pending"?0:(s==="approved"?1:2);
      return w(a.status)-w(b.status) || (b.createdAt-a.createdAt);
    });

    elList.innerHTML = "";
    if(!sorted.length){
      elList.innerHTML = '<div class="hint">Sem inscri√ß√µes ainda.</div>';
      return;
    }

    for(const it of sorted){
      const div = document.createElement("div");
      div.className = "item";

      div.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="title">${escapeHtml(it.nick || "‚Äî")} <span class="badge ${badgeClass(it.status)}">${escapeHtml(it.status)}</span></div>
            <div class="meta">idade: <b>${escapeHtml(String(it.idade||"‚Äî"))}</b> ‚Ä¢ token: <b>${escapeHtml(it.token||"‚Äî")}</b></div>
            <div class="meta">criado: ${escapeHtml(fmtTime(it.createdAt||0))}</div>
          </div>
          <div class="actions">
            ${it.status==="pending" ? `
              <button class="a ok" data-act="approve" data-id="${escapeHtml(it.id)}">Aprovar</button>
              <button class="a no" data-act="reject" data-id="${escapeHtml(it.id)}">Rejeitar</button>
            ` : `
              <button class="a ghost" data-act="copy" data-id="${escapeHtml(it.id)}">Copiar ID</button>
            `}
          </div>
        </div>
        <div class="meta"><b>discord:</b> ${escapeHtml(it.discordTag||"‚Äî")} ‚Ä¢ <b>link:</b> ${escapeHtml(it.linkBonde||"‚Äî")}</div>
        <div class="meta"><b>motivo:</b> ${escapeHtml(it.motivo||"‚Äî")}</div>
      `;

      div.addEventListener("click", async (e)=>{
        const btn = e.target.closest("button");
        if(!btn) return;
        e.preventDefault();
        e.stopPropagation();

        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        try{
          if(act==="copy"){
            await navigator.clipboard.writeText(id);
            toast("Copiado ‚úÖ");
            return;
          }
          if(act==="approve"){
            await apiPost(`/api/admin/submissions/${encodeURIComponent(id)}/approve`);
            logLine(`‚úÖ aprovado ${id}`);
            toast("Aprovado ‚úÖ");
            await refreshNow();
            return;
          }
          if(act==="reject"){
            await apiPost(`/api/admin/submissions/${encodeURIComponent(id)}/reject`);
            logLine(`‚ùå rejeitado ${id}`);
            toast("Rejeitado ‚ùå");
            await refreshNow();
            return;
          }
        }catch(err){
          toast("Erro: " + (err.message||err));
          logLine("ERRO: " + (err.message||err));
        }
      });

      elList.appendChild(div);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  let timer = null;

  async function refreshNow(){
    elStatus.textContent = "Carregando...";
    try{
      const data = await apiGet("/api/admin/submissions");
      render(data.items || []);
      elStatus.textContent = "Online ‚úÖ";
    }catch(err){
      elStatus.textContent = "Erro ‚ùå";
      toast("Erro: " + (err.message||err));
      logLine("ERRO: " + (err.message||err));
    }
  }

  readCfg();
  refreshNow();
  timer = setInterval(refreshNow, 5000);
</script>
</body>
</html>
